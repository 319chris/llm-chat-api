<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LLM Chat API Demo</title>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; max-width: 900px; margin: 40px auto; padding: 0 16px; }
    h1 { margin-bottom: 6px; }
    .hint { color: #555; margin-top: 0; }
    input, textarea, button { width: 100%; font-size: 14px; padding: 10px; margin: 8px 0; }
    textarea { height: 140px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    pre { background: #0b0f19; color: #e6edf3; padding: 14px; border-radius: 10px; overflow: auto; }
    button { cursor: pointer; font-weight: 600; }
    button[disabled] { opacity: 0.6; cursor: not-allowed; }
    .small { font-size: 12px; color: #666; }
  </style>
</head>
<body>
  <h1>LLM Chat API Demo</h1>
  <p class="hint">Paste your deployed <code>chat_url</code> (Terraform output) and send a message.</p>

  <label>chat_url</label>
  <input id="chatUrl" placeholder="https://xxxx.execute-api.ap-southeast-2.amazonaws.com/chat" />

  <div class="row">
    <div>
      <label>temperature</label>
      <input id="temp" type="number" step="0.1" value="0.2" />
    </div>
    <div>
      <label>max_tokens</label>
      <input id="maxTokens" type="number" step="1" value="64" />
    </div>
  </div>

  <label>message</label>
  <textarea id="msg" placeholder="Say hello in one sentence."></textarea>

  <!-- IMPORTANT: type="button" prevents form-submit refresh issues -->
  <button id="send" type="button">Send</button>
  <p class="small">Tip: This calls your live AWS endpoint. Keep max_tokens small to control cost.</p>

  <h2>Response</h2>
  <pre id="out">{}</pre>

  <script>
    // Run only after DOM is ready (prevents null element issues)
    window.addEventListener("DOMContentLoaded", () => {
      const chatUrlEl = document.getElementById("chatUrl");
      const tempEl = document.getElementById("temp");
      const maxTokensEl = document.getElementById("maxTokens");
      const msgEl = document.getElementById("msg");
      const outEl = document.getElementById("out");
      const sendBtn = document.getElementById("send");

      // Hard fail early if ids mismatch
      if (!chatUrlEl || !tempEl || !maxTokensEl || !msgEl || !outEl || !sendBtn) {
        console.error("Element id mismatch", { chatUrlEl, tempEl, maxTokensEl, msgEl, outEl, sendBtn });
        outEl.textContent = "Error: UI element id mismatch. Open Console to see details.";
        return;
      }

      console.log("Demo script loaded ✅");

      // Prefill chat_url from query param, fallback to localStorage
      const params = new URLSearchParams(window.location.search);
      const preset = params.get("chat_url");
      const presetUrl = preset ? decodeURIComponent(preset) : "";
      chatUrlEl.value = presetUrl || localStorage.getItem("chat_url") || "";

      chatUrlEl.addEventListener("input", () => {
        localStorage.setItem("chat_url", chatUrlEl.value);
      });

      function pretty(obj) {
        return JSON.stringify(obj, null, 2);
      }

      sendBtn.addEventListener("click", async () => {
        console.log("Send clicked ✅");

        const chatUrl = chatUrlEl.value.trim();
        if (!chatUrl) {
          outEl.textContent = "Please paste chat_url first.";
          return;
        }

        const payload = {
          messages: [{ role: "user", content: msgEl.value || "Say hello in one sentence." }],
          temperature: Number(tempEl.value || 0.2),
          max_tokens: Number(maxTokensEl.value || 64),
        };

        sendBtn.disabled = true;
        outEl.textContent = "Sending...";

        try {
          const r = await fetch(chatUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const text = await r.text();
          let data;
          try { data = JSON.parse(text); } catch { data = { raw: text }; }

          outEl.textContent = pretty({ http_status: r.status, ...data });
        } catch (e) {
          outEl.textContent = "TypeError: Failed to fetch\n\n" + String(e) +
            "\n\nOpen DevTools Console/Network to see if this is CORS.";
        } finally {
          sendBtn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>